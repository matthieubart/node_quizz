<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Quizz</title>
        <style type="text/css">
            *{
                margin: 0;
                padding: 0;
            }

            h1{
                text-align: center;
            }

            #quizz,#connexion{
                display: none;
            }

            #connexion, #questions{
                position: absolute;
                bottom: 50%;
                width: 100%;
                text-align: center;
            }

            #formulaire_reponse{
                position: absolute;
                width: 100%;
                text-align: center;
                bottom: 0;
            }

            #gagnants, #reponsesproposees{
                position: absolute;
                width: 100%;
                text-align: center;
                top: 90%;
            }

            #gagnants{
                left: 10%;
            }

            #reponsesproposees{
                right: 10%;
            }

            #scores{
                border: 3px solid black;
                padding: 5px;
                position: absolute;
                right: 0;
            }

        </style>
    </head>
 
    <body>
        <div id="connexion">
            <form action="/" method="post" id="formulaire_connexion">
                <input type="text" name="pseudonyme" id="pseudonyme" placeholder="Votre pseudonyme..." size="50" autofocus />
                <input type="submit" id="envoi_pseudonyme" value="Envoyer" />
            </form>
        </div>

        <div id="quizz">
            <section id="attente">
                
            </section>

            <section id="questions">
                
            </section>
            <section id="infos">
                <div id="decompte">
                    
                </div>
                <div id="reponsesproposees">
                    
                </div>

                <div id="gagnants">
                    
                </div>
                <div id="scores">
                    
                </div>
            </section>

            <form action="/" method="post" id="formulaire_reponse">
                <input type="text" name="reponse" id="reponse" placeholder="Votre réponse..." size="50" autofocus />
                <input type="submit" id="envoi_reponse" value="Envoyer" />
            </form>
        </div>


        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            $(document).ready(function(){
                var temps_decompte = 15 ;

                //Socket IO
                var socket = io.connect('http://localhost:8080');

                socket.on("error", function(message){
                    alert("Le serveur s'est arrété");
                    window.location.reload();
                });

                socket.on('attente', function(){
                    $("#attente").html("Attente d'un autre joueur.");
                    $("#formulaire_reponse").css("display", "none");
                });

                socket.on('decompte_debut_partie', function(){
                    $("#attente").html("");
                    $("#formulaire_reponse").css("display", "none");

                    var cpt = 2 ;
                    var x ;
                    function decompte()
                    {
                        if(cpt>=0){
                            $("#decompte").html("<h1>"+cpt+"</h1>");
                            cpt-- ;
                            x = setTimeout(decompte,1000) ;
                        }
                        else{
                            clearTimeout(x) ;
                            //Les secondes sont passés
                            $("#decompte").html("");
                            socket.emit("debut_partie");
                        }
                    }
                    decompte();
                });

                socket.on('decompte', function(){
                    temps_decompte = 15 ;
                    var x ;
                    var id_question_envoye = false;
                    function decompte()
                    {
                        if(temps_decompte>=0){
                            $("#decompte").html("<h1>"+temps_decompte+"</h1>");
                            temps_decompte-- ;
                            x = setTimeout(decompte,1000) ;
                        }
                        else{
                            clearTimeout(x) ;
                            //Les secondes sont passés
                            $("#decompte").html("");
                            if(!id_question_envoye){
                                id_question = $("#questions").find("span").text();
                                socket.emit("question_suivante", parseInt(id_question));
                                id_question_envoye=true;
                            }
                        }
                    }
                    decompte();

                });

                socket.on('decompte', function (data) {
                    $('#decompte').html("<h1>"+data.countdown+"</h1>");
                });

                socket.on('parti_deja_commence', function(){
                    window.location.reload();
                });

                socket.on('question', function(question) {
                    $("#formulaire_reponse").css("display", "block");
                    $("#attente").html("");
                    $("#questions").html(question);
                })

                socket.on('bonne_reponse', function(pseudo){
                    temps_decompte = 15;
                    $("#reponsesproposees").html("");
                    $("#gagnants").html(pseudo+" a trouvé la bonne réponse. <br />");
                });

                socket.on('mauvaise_reponse', function(reponse){
                    $("#reponsesproposees").append(reponse+ " n'est pas la bonne réponse.<br />");
                });

                socket.on('vainqueur', function(vainqueur){
                    var message = "";
                    if(vainqueur=="egalite"){
                        message = "Aucun vainqueur pour cette partie";
                    }else{
                        message = "Le vainqueur est "+vainqueur;
                    }
                    alert(message);
                    window.location.reload();
                });

                socket.on('scores', function(scores){
                    $("#scores").html("");
                    $.each(scores, function(pseudo, score) {
                        pseudo = pseudo.split(";");
                        pseudo = pseudo[1];
                        $("#scores").append("<div class='score'>"+pseudo+": <strong>"+score+"</strong></div>");
                    });
                });

                //Général
                $("#quizz").css("display","none");
                $("#connexion").css("display","block");

                $('#formulaire_reponse').submit(function () {
                    var reponse = $('#reponse').val();
                    socket.emit('reponse', reponse); 
                    $('#reponse').val('').focus();
                    return false;
                });

                $('#formulaire_connexion').submit(function () {
                    var pseudo = $('#pseudonyme').val();
                    socket.emit('nouveau_client', pseudo);
                    $("#quizz").css("display","block");
                    $("#connexion").css("display","none");
                    return false;
                });

                $(document).on("click", "#rejouer", function(){
                    window.location.reload();
                });
            });

        </script>
    </body>
</html>

